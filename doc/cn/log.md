# CoreLooper日志设计
XiongWanPing 2019.09.29

工欲善其事,必先利其器
日志对app开发是必不可少的，为此我们决定打造一个好的日志系统

考虑到目前普遍的日志都有各种各样的缺陷，决定重新设计一下日志，目标如下：
* 高性能 
* 高可靠性
  <br>常见的日志一般采用写文件,写console，又分为同步写和异步写，
同步写是阻塞方式，异步写一般是在单独的log线程中写文件，其他线程post到此log线程，这又涉及到内存动态分配，
即每条日志都是采用动态内存(可以优化一下，即自建内存池)
<br>同步写日志的优势是不会遗漏，当app意外crash时可比较精确的定位最后一条日志,缺点是性能较低
<br>异步写的优势是性能较高，但当app意外crash时有可能遗漏一部分日志，给诊断带来困难

过去我们二选一,现在我们全都要!
我们的想法是，即要保证高性能，也要保证高可靠性。综合考虑，决定采用共享内存来做日志。

共享内存有几个特点，正好匹配我们的需求。
- 写日志其实就是直接写内存，不需要系统调用，不需要fflush,性能比写文件要高的多
- 当app意外crash时，共享内存仍然能存在,app crash不影响已提交的日志

日志要包含的信息字段
 - app name,instance name
 - pid
 - threadId
 - tag(模块)
 - file,line
 为提高性能,有些字段只需要传一次,比如app name,instance name和pid

## Log框架设计

做一个跨平台的LogStudio,支持收集多个app的共享内存日志
- app和LogStudio运行在同一系统中，可以使用共享内存
- 要保证LogStudio先运行，然后才启动app,这个很容易办到.
- 当app已运行后才运行LogStudio,需要提供辅助办法让app通知LogStudio,这个也容易办到

app通过udp通知LogStudio
LogStudio可通过websocket对外提供日志浏览，过滤等功能

如果OS支持按特征枚举file mapping,则可以做的更自动化一些


# todo
有些问题需要进一步研究确认
## 静态变量构造和析构顺序
最好能做到在main()之前和main之后也能正常记录log
<br>很自然的会想到用MemoryLog静态变量，但对全局变量而言，编译器目前没有明确的构造和析构顺序。




